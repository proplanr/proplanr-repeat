<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/polymerfire.html">
<link rel="import" href="../polymerfire/firebase-query.html">
<link rel="import" href="../polymerfire/firebase-document.html">
<link rel="import" href="./proplanr-repeat.html">
<link rel="import" href="../moment-element/moment-element.html">

<dom-module id="proplanr-repeat-firebase">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    

    <firebase-document
      id="repeatData"
      app-name="proplanr-repeat"
      path="/repeats/key1"
      data="{{repeatData}}">
    </firebase-document>

    <firebase-query log
      id="repeatsData"
      app-name="proplanr-repeat"
      path="/repeats"
      data="{{repeatsData}}">
    </firebase-query>

    <firebase-query
      id="actionData"
      app-name="proplanr-repeat"
      path="/actions"
      data="{{actionsData}}">
    </firebase-query>

    <proplanr-repeat></proplanr-repeat>

  </template>    
  <script>
    Polymer({
      is: 'proplanr-repeat-firebase', 

      listeners: {
        'saveRepeat': 'saveData'
      },
    // listen for saveRepeat
    ready: function(event) {
      this.db = this.$.actionData.app.database();
      console.log('proplanr-repeat-firebase',this.db);
    },

    saveData: function(data) {
      // console.log('logActivity:',action,description,listId,this.user);
      // Log activity
        // var db = this.$.firebaseAuth.app.database();
      // var now = new Date().toLocaleString('en-US', {timeZone: 'America/Los_Angeles'});
        // var now = new Date().toLocalString();
      // let newRepeatId = db.ref('/repeats').push(data).key;

      this.db.ref('/repeats').push(data.detail).then(snapshot => {
        let repeat_key = snapshot.key;
        let repeat = data.detail;
        // add actions for number occurrencies or end date

        if(repeat.ends === 'after') {
          let every = repeat.repeat_every;
          saveActions(every);
        } else if(repeat.ends === 'on') {
          
        }

        else {
          console.log("end on");
        }
        saveActions: function(numberOfActions) {
        let due_date;
          for(let i = 0; i < repeat.after_occurrences; i++) {
            if(repeat.repeat_frequence === "days") {
              if(i === 0) {
                due_date = repeat.start_on;
              } else {
                due_date = moment(due_date).add(every, 'days');
              }
            } else if(repeat.repeat_frequence === "weeks") {
              if(i === 0) {
                due_date = repeat.start_on;
              } else {
                due_date = moment(due_date).add(every, 'weeks');
              } 
            } else if(repeat.repeat_frequence === "months") {
              if(i === 0) {
                due_date = repeat.start_on;
              } else {
                due_date = moment(due_date).add(every, 'months');
              }
            } else if(repeat.repeat_frequence === "quarters") {
              if(i === 0) {
                due_date = repeat.start_on;
              } else {
                due_date = moment(due_date).add(every, 'quarters');
              }
            } else if(repeat.repeat_frequence === "years") {
              if(i === 0) {
                due_date = repeat.start_on;
              } else {
                due_date = moment(due_date).add(every, 'years');
              }
            }
            this.db.ref('/actions').push({
              repeat_key: repeat_key,
              title: repeat.title,
              due_date: due_date.toLocaleString()
            })
          }
      } 

        });
      },

      
    });


  </script>
</dom-module>